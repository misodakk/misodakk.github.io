# Windows安装-分区与引导


熟练安装 / 重装 Windows 应该是每一个热爱捣鼓计算机的必修课了吧，还记得小时候第一次捣鼓时的提心吊胆，搞到凌晨那是经常的事，也彻底搞挂过 BIOS，现在已经是游刃有余了，不过装系统的机会也少了，不像 XP  Win7 时代那么多修改版，但是我发现有一些概念我从来没去了解过，只是按照网上大佬的教程在做。

小时候还是 XP、Win7 时代，那时候什么雨林木风、番茄花园、老毛桃之类的才是顶流，以及那熟悉的 Ghost 界面，纯傻瓜式的操作。<!--more-->

现在一版都是用原版 ISO 镜像制作启动盘或者 PE 中用原版镜像还原了，目前我还用的就是微 PE、IT 天空的优启通、Ventoy。firpe 也挺不错的。

我认为 Ventoy 里放系统镜像和几个 PE 镜像是最佳组合。本次根据我的调研记录下磁盘分区和引导相关的东西。

从初中就包揽了周围邻居的电脑维修，虽然不一定能修好就是了。
## 分区类型
使用 Windows 下，磁盘分区现在基本都是 GUID 或者叫 GPT，不论是之前的 MBR 还是 GUID，表示的是文件在硬盘上的存储方式，由操作系统管理，对硬盘没有什么影响。

简单说，磁盘在分区表中存储了每个分区的位置和大小信息，操作系统根据这些信息将分区视作一个逻辑磁盘。从而防止数据丢失以及增加磁盘空间的利用率

由于 Windows 11 操作系统不支持传统引导模式，这意味着 GUID / GPT 磁盘分区是安装 Windows 11 的基本要求之一。
### MBR 分区
MBR （Master Boot Record） 的意思就是主引导记录，目前我们使用的硬盘绝大部分都是 512 字节的一个扇区（MBR 时代 512 字节是行业标准）。

MBR 分区它的特点是最多有 4 个主要分区（或三个主分区和一个扩展分区，扩展分区下可以有多个逻辑分区），**最多可管理 2TB 的数据**；

主引导记录它是存在于磁盘驱动器开始部分的 0 号扇区，只有 512 个字节，在这 512 字节中，分别有引导程序、分区表、结束标志记录签名三个部分。

1. 主引导代码 (Master Boot Code)：占 446 字节，负责加载操作系统。
2. 分区表 (Partition Table)：占 64 字节，这是我们讨论的核心。
3. 结束标志 (Boot Signature)：占 2 字节（固定为 0x55AA），表示这个扇区是有效的。

具体到分区表信息，就只有 64 个字节，一个主分区用 16 字节来表示，所以这就解释了为什么 MBR 只能有 4 主要分区，问题的关键就在于，描述分区位置和大小的这两个字段都只有 4 字节（使用 32 位进行 LBA 寻址）。

所以最大只能表示 2^32 个地址，最大单分区容量为 2^32*512 字节 = 2048GB，也就是我们通常说的 MBR 最大支持 2TB 单盘容量。超过 2TB 的硬盘只能管理 2TB，因为分区表大小只能记录到这些容量的位置。

### GPT 分区
GPT 的意思是 GUID Partition Table，即“全局唯一标识磁盘分区表”，是源自 EFI 标准的一种较新的磁盘分区表结构的标准，GPT 提供了更加灵活的磁盘分区机制。支持最大容量 9.4ZB（使用 64 位 (8 字节) 来进行 LBA 寻址）、多分区、分区表自带备份。

> LBA (Logical Block Addressing) 是现代硬盘寻址的方式。它把整个硬盘看作一个从 0 开始编号的、连续的扇区（Sector）数组。我们通过扇区的编号就能找到数据，而不用关心它具体在哪个磁头、哪个柱面。

不同的操作系统在初始化 GPT 磁盘时，会创建不同的特殊分区，EFI 系统分区 (EFI System Partition, ESP) 存储操作系统的引导加载程序（Bootloader）、驱动程序和启动时需要的文件；所以**无论使用哪种分区工具，这个分区是都有的， 格式固定为 FAT32**。

ESP 分区常见的大小范围是 100MB 到 500MB 之间。Windows 默认标准：100 MB、微软针对 4K 扇区硬盘的建议：260 MB、电脑制造商 (OEM) 的常见大小：260 MB ~ 500 MB（存放一些额外的诊断工具、固件更新程序或其他引导相关的文件）、多重引导系统 (Multi-boot) 的建议：300 MB ~ 512 MB。

---

除了 ESP 分区，还可能会见到一些其他小分区：

**微软保留分区 (Microsoft Reserved Partition, MSR)** 这是 Windows 在 GPT 磁盘上专门保留的一块空间，为以后可能的功能做准备。它不存储用户数据，也没有文件系统（不会被格式化），你在“我的电脑”里也看不到它。

在 Windows 10/11 中，它通常是 16MB。

虽然技术上删除它后 Windows 仍然可以运行，但这强烈不被推荐。缺少 MSR 可能会导致未来某些磁盘管理功能无法正常工作。

分区对齐 (Partition Alignment) 产生的微小间隙，为了性能，特别是对于 SSD 和使用了“高级格式化”(Advanced Format, 4K 扇区)的机械硬盘，分区的起始位置需要“对齐”。

所以就可能出现下一个分区就不会紧挨着它开始，而是会从下一个 1 MiB 的边界开始。这就在两个分区之间留下了一个未被使用的、非常小的空间（通常小于 1MB）。

还可能存在一个**恢复分区 (Recovery Partition)** - 存放 Windows 恢复环境 (WinRE)。
它是一个特殊的、通常被隐藏起来的分区，里面存放着一套工具，用于在你的主操作系统（比如 C 盘里的 Windows）出现严重问题时进行修复、重置或恢复。

当你无法正常进入 Windows 时，系统会自动（或你手动）引导到这个恢复分区。在这里，你会看到一个蓝色的菜单，提供多种修复工具。

恢复分区主要是两种方式创建的：
1. 由 Windows 安装程序创建：当你安装 Windows 10/11 时，安装程序会自动创建一个几百 MB 大小的恢复分区，里面只包含标准的 WinRE 环境。
2. 由电脑制造商创建 (OEM)：品牌机（如联想、戴尔、惠普）通常会创建一个更大的恢复分区（可能好几个 GB）。
   这个分区除了包含标准的 WinRE，还包含一个完整的、带有所有驱动和预装软件的系统镜像。使用这种恢复分区进行“一键恢复”，能让你的电脑完完全全地回到刚买来时的状态。

硬盘空间足够的话，就留着这些分区吧。

## 引导

在启动方式上目前常见的是 **UEFI Boot 和 Legacy Boot** ， 设置上，一定要配合 GPT 和 MBR，否则电脑会出现无法启动，它们都负责在按下电源按钮后、操作系统启动之前，对硬件进行初始化并引导操作系统。

### Legacy Boot

Legacy Boot 也被称为 BIOS 引导，BIOS (Basic Input/Output System) 是一段固化在主板上一个 ROM 芯片里的软件，从上世纪 80 年代 IBM PC 时代开始就一直在使用。
可以引导 16 位的 DOS 操作系统、32 位的操作系统、引导 64 位的操作系统，（只要 CPU 支持即可）。

开机后，当按 BIOS 的引导顺序找到一个可引导的硬盘时，它会去读取这个硬盘的第一个扇区（512字节），也就是我们之前讨论的 MBR (主引导记录)。BIOS 将 MBR 中的引导代码加载到内存中并执行它。

MBR 的引导代码接着会去寻找活动分区，然后加载该分区里的操作系统引导程序（比如 Windows 的 bootmgr 或 Linux 的 GRUB），最终由这个引导程序来启动操作系统。

Legacy Boot 的特点：
1. 历史悠久：兼容性极好，几乎所有老设备和老系统都支持。
2. 依赖 MBR：它只能识别 MBR 分区格式的硬盘，这也直接导致了它无法引导超过 2TB 的硬盘。
3. 速度较慢：整个引导过程是串行的，一步接一步，硬件初始化比较耗时。
4. 界面简陋：通常是蓝底白字的文本界面，只能用键盘操作。
5. 安全性差：BIOS 无法验证将要执行的引导代码是否被篡改，容易受到 "bootkit" 等恶意软件的攻击。

### UEFI

而 UEFI (Unified Extensible Firmware Interface) 即“统一可扩展固件接口”，是旨在取代传统 BIOS 的新一代标准。**与操作系统位宽是一一对应的**，因为 UEFI 分为 32 位与 64 位（现在应该都是 64 位的），32 位的 UEFI 需要安装 32 位的操作系统，64 位的 UEFI 需要 64 位的操作系统。

它自检过程通常比 BIOS 更快，**可以并行处理**。之后会寻找 EFI 系统分区 (ESP)：UEFI 不再是盲目地去读第一个扇区。它会直接去寻找硬盘上一个叫 ESP (EFI System Partition) 的特殊分区。这个分区通常是 FAT32 格式。

之后会执行引导文件：UEFI 固件能够识别文件系统，它会在 ESP 分区中查找特定路径下的引导文件（一个 .efi 文件，例如 Windows 的是 `\EFI\Boot\bootx64.efi` 或 `\EFI\Microsoft\Boot\bootmgfw.efi`）。找到引导文件后，UEFI 直接执行它，启动操作系统的引导程序。

UEFI Boot 的特点：
1. 支持 GPT 分区

2. 并行化的硬件初始化，启动速度快

3. 界面友好：支持图形化界面和鼠标操作，设置更直观。

4. 安全性高：支持一个名为 "Secure Boot" (安全启动) 的重要功能。

   它能确保在引导过程中，所有执行的代码（从驱动到操作系统引导程序）都经过了可信的数字签名，有效防止恶意软件在操作系统启动前加载。

5. 功能更强：内置了网络功能（可以在开机时联网诊断）、更完善的驱动支持和更灵活的扩展性。

市面上绝大部分笔记本和台式机都是 64 位的 UEFI，因此我们通常才会错误的认为 “UEFI 只能安装 64 位 Windows 操作系统”


你可能在主板设置里看到过 CSM (Compatibility Support Module, 兼容性支持模块) 这个选项。

CSM 是 UEFI 固件里的一个“插件”或“开关”。它的作用就是在 UEFI 环境下模拟出一个传统的 Legacy BIOS 环境。
为了向后兼容；当你需要安装一个不支持 UEFI 的老旧操作系统（比如 32 位的 Windows 7），或者使用一些不支持 UEFI 的老旧硬件（比如某些显卡或阵列卡）时，就需要开启 CSM。开启后你的电脑会以 Legacy BIOS 的方式进行引导。

## 安装方式

使用 Dism++ 安装系统的时候，可能会看到 WIMBoot、Compact 之类的选项，一版是用不到的。

> [!INFO]
> 重装系统的时候，如果原来存在正常使用的系统，那么不需要添加引导，要不然可能会出现两个重复的启动菜单，还要 msconfig 里去删掉一个。

VHDX、WTG、WIMBoot 之类的方式，除非是特殊场景，否则就不要轻易尝试了，正常安装即可。

### VHDX 安装系统
VHD 是 Windows 虚拟磁盘格式，文件大小是固定的，可以在磁盘管理工具里创建（大小需要 50G+）、挂载，VHDX 就是动态占用，这个和虚拟机的磁盘一个概念。

把系统安装到 VHDX 的好处就是可以方便系统还原和安装不同的系统版本，但是不推荐进行设备之间的迁移，除非是硬件是一样的。

当然它也会有一些限制，例如不能休眠，性能也会有损失，会弱一些。

如果你使用 Ventoy 它自带 VHD 加载模块。

### WIMBoot 启动 / Compact
它是 Win8 中新增的一种，通过使用一种 wim 格式的镜像文件来启动系统，wim 可以理解为一种**高度压缩的、只读的**系统镜像文件，它可以从系统的 ISO 中的 `install.wim` 进行提取。

它的核心目标是**在存储空间极其有限的设备上运行完整的 Windows 系统**。

使用这种方式，系统盘里只有一些指针文件，大大减小了系统文件的占用，不过占用的内存可能会变大；
WIMBoot 可以为用户节省出 4-7GB 的可用空间，重置和恢复系统极快。每次读取系统文件都需要实时从 WIM 镜像中解压缩，这会消耗额外的 CPU 资源，并增加文件读取的延迟。

不过有人测试说微软进行过特殊优化，读取速度是非常快的。但是更新系统是个大问题。

后来被 Compact OS 取代，Compact 不再需要一个独立的 WIM 镜像分区和指针文件。它直接将 C 盘上的系统文件逐个进行压缩（in-place compression）。系统读取文件时，也是实时解压。任何 Windows 10/11 电脑都可以随时开启或关闭 Compact OS 功能。

### WTG

Windows To Go，简称 WTG，可以通俗地理解为 “**装在 U 盘里的 Windows 系统**”。

它的核心目标是：让你能够将一个完整的、可启动的、个人化的 Windows 工作环境，安装到一个经过认证的 USB 驱动器（比如高速 U 盘或 USB 移动硬盘）上，当然也有民间工具可以安装到任何 U 盘上。

你可以拿着这个 USB 驱动器，插到任何一台符合最低硬件要求的电脑上，从这个 USB 驱动器启动，进入你自己的、熟悉的 Windows 系统，里面有你自己的文件、应用和设置。当你拔下 U 盘离开后，那台电脑不会留下任何痕迹。

它是微软在 Windows 8 企业版中首次推出、并在 Windows 10 中延续的一项官方功能。
我感觉与 VHDX 的方式很像（一个是侧重隔离性，一个是便携性，VHDX 方式还是和硬件有点关联的，一般是同主机多系统环境，**WTG 则基本是完全的硬件无关，所以对微软来说也更难维护**），也都有一些限制，例如不能休眠，不过性能应该比 VHDX 要好。

但微软已经在 Windows 10 版本 2004 (2020年5月更新) 中正式宣布放弃并移除了该功能。原因主要是 硬件体验难以保证、更新容易出问题。

